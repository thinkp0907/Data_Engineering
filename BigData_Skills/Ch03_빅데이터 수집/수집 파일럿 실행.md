## 수집 파일럿 실행

### 수집 파일럿 실행 1단계 - 수집 아키텍처

#### 수집 요구사항

빅데이터 파일럿 프로젝트의 두 가지 요구사항을 다시 한번 살펴보자. 그리고 빅데이터 수집 관점에서 요구사항들을 더 구체화하고, 이를 해결하기 위한 솔루션과 기술 요소들을 도출한다.



- **요구사항 1:** 차량의 다양한 장치로부터 발생하는 로그 파일을 수집해서 기능별 상태를 점검한다
- **요구사항 2:** 운전자의 운행 정보가 담긴 로그를 실시간으로 수집해서 주행 패턴을 분석한다.

#### 요구사항 구체화 및 분석

| 수집 요구사항 구체화                                         | 분석 및 해결 방안                                            |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1. 스마트카로부터 로그파일들이 주기적으로 발생한다           | 플럼을 이용해 대용량 배치 파일 및 실시간 로그 파일을 수집    |
| 2. 스마트카의 배치 로그 파일 이벤트를 감지해야 한다.         | 플럼의 Source 컴포넌트 중 SpoolDir를 이용해 주기적인 로그 파일 발생 이벤트를 감지 |
| 3. 스마트카의 실시간 로그 발생 이벤트를 감지해야 한다.       | 플럼의 Source 컴포넌트 중 Exec-Tail을 이용해 특정 로그 파일에서 로그 생성 이벤트를 감지 |
| 4. 스마트카가 만들어내는 로그 데이터에 가비지 데이터가 있을 수 있다. | 플럼의 Interceptor를 이용해 정상 패턴의 데이터만 필터링      |
| 5. 수집 도중 장애가 발생해도 데이터를 안전하게 보관 및 재 처리할 수 있어야 한다. | 플럼의 메모리 Channel 및 카프카 Broker 사용으로 로컬 디스크의 파일시스템에 수집 데이터를 임시 저장 |
| 6. 스마트카의 실시간 로그 파일은 비동기 처리로 빠른 수집 처리를 해야 한다. | 플럼에서 수집한 데이터를 카프카 Sink 컴포넌트를 이용해 카프카 Topic에 비동기 전송 |

**['스마트카' 프로젝트의 수집 요구사항 분석]**

#### 수집 아키텍처

수집 요구사항을 참고해서 스마트카의 빅데이터 분석을 위한 파일럿 프로젝트의 수집 아키텍처를 구성.

![image-20210408142417851](C:\Users\Chorlock\AppData\Roaming\Typora\typora-user-images\image-20210408142417851.png)**['스마트카' 로그/파일 수집 아키텍처]**

파일럿 프로젝트의 수집 아키텍처는 원천 데이터의 발생 유형에 따라 크게 2개의 레이어로 나눌 수 있다.

1. 대용량 로그 파일을 주기적으로 수집해서 표준 입출력 로거로 보여주는 플럼 에이전트 1 레이어
2. 실시간으로 발생하는 로그를 라인 다위로 수집해 카프카의 Topic에 전송하는 플럼 에이전트 2 레이어



#### 로그 시뮬레이터

스마트카의 상태 정보와 운전자의 운행 정보 로그를 가상으로 만드는 자바 로그 발생기다.

**① 스마트카 상태 정보**: 100대 스마트카 장치들의 상태 정보를 3초 간격으로 발생시키며, 1일 100MB의 로그파일이 만들어진다.

**⑥ 스마트카 운전자 운행 정보**: 100명의 스마트카 운전자들의 운행 정보를 실시간으로 발생시키며, 발생된 하나의 운행 정보 로그는 4KB 미만이다. 동시에 최대 400KB 용량으로 실시간 데이터가 발생된다.



#### 플럼 에이전트 1

스마트카 상태 정보를 기록한 로그 파일을 일별로 수집하기 위한 배치성 플럼 에이전트다.

**② SpoolDir Source:** 약속된 로그 발생 디렉터리를 모니터링하다가 정의된 로그 파일 발생 시 해당 파일의 내용을 읽어서 수집하는 기능을 제공한다.

**③ Memory Channel:** SpoolDir Source로부터 수집된 데이터를 메모리 Channel에 중간 적재한다. 버퍼링 기능을 제공하며, Sink와 연결되어 트랜잭션 처리를 지원한다.

**④ Logger Sink:** Channel로부터 읽어들인 데이터를 플럼의 표준 로그 파일로 출력하게 된다.



#### 플럼 에이전트 2

스마트카 운전자의 운행 정보를 실시간으로 수집하기 위한 실시간성 플럼 에이전트다.

**⑦ Exec-Tail Source:** 로그가 쌓이고 있는 파일에 Tail 파이프라인을 이용해 실시간으로 데이터를 수집하는 기능을 제공한다

**⑧ Memory Channel:** Exec-Tail Source로부터 수집된 데이터를 메모리 Channel에 버퍼링 처리를 하면서 임시 적재한다.

**⑨ Kafka Sink:** Channel로부터 읽어들인 데이터를 카프카 Broker의 특정 토픽에 비동기 방식으로 전송하는 Provider 역할을 수행한다.



#### 기타

플럼이 수집한 로그 데이터를 임시 출력 및 저장한다.

**⑤ Flume Stdout:** 플럼의 Logger-Sink를 통해 표준 출력 로그가 출력된다.

**⑩ Kafka Topic:** 플럼의 Kafka-Sink는 수집된 실시간 로그를 임시 적재한다.



---

### 수집 파일럿 실행 2단계 - 수집 환경 구성

Cloudera Manager를 이용해 플럼과 카프카를 Server02 가상 머신에 설치한다. 우선 플럼을 설치해 보겠다.